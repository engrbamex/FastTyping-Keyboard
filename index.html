<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Typing Keyboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles for professionalism */
        body {
            font-family: 'Inter', sans-serif;
            /* Main gradient background */
            background:
                linear-gradient(135deg, #e0e7ff 0%, #c3daff 100%),
                /* Keyboard pattern layer - subtle grid */
                repeating-linear-gradient(
                    0deg,
                    #d0d8ff 0px,
                    #d0d8ff 2px,
                    transparent 2px,
                    transparent 22px
                ),
                repeating-linear-gradient(
                    90deg,
                    #d0d8ff 0px,
                    #d0d8ff 2px,
                    transparent 2px,
                    transparent 32px
                );
            background-blend-mode: overlay, normal, normal; /* Blend modes to make pattern subtle */
            background-size: auto, 30px 30px, 40px 40px; /* Adjust size for pattern repeat */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 35px; /* Slightly reduced padding */
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            max-width: 800px; /* Made smaller */
            width: 100%;
            text-align: center;
            border: 1px solid #d1d5db; /* Subtle border */
        }
        h1 {
            color: #2563eb; /* Deeper blue for main heading */
            font-weight: 800; /* Extra bold */
            margin-bottom: 30px; /* More space */
        }

        /* Text Display Area */
        .text-display {
            background-color: #f1f5f9; /* Lighter background for text */
            padding: 25px; /* Increased padding */
            border-radius: 12px;
            margin-bottom: 30px;
            font-size: 1.5rem; /* Larger font size */
            line-height: 1.9; /* Improved line height */
            text-align: left;
            min-height: 140px; /* Taller */
            overflow-y: auto;
            border: 2px solid #cbd5e1;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.08); /* More pronounced inset shadow */
            user-select: none;
            color: #334155; /* Darker text for better contrast */
        }
        .text-display span {
            transition: background-color 0.1s, color 0.1s;
            display: inline-block;
            padding: 0 2px; /* Slightly more padding for highlighted letters */
        }
        .correct {
            color: #15803d; /* Darker green for correct */
        }
        .incorrect {
            background-color: #dc2626; /* Stronger red background for incorrect */
            color: #ffffff;
            border-radius: 4px;
        }
        .current {
            background-color: #93c5fd; /* Medium blue for current character */
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); /* Subtle glow for current char */
        }

        /* User Input Field */
        .input-field {
            width: 100%;
            padding: 18px 25px; /* Larger padding */
            border: 2px solid #94a3b8;
            border-radius: 12px;
            font-size: 1.4rem; /* Larger font */
            margin-bottom: 30px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            color: #1f2937; /* Darker input text */
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* More prominent focus ring */
        }

        /* Stats Section */
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 1.3rem; /* Larger font */
            color: #4b5563; /* Slightly darker color */
            flex-wrap: wrap;
            gap: 20px; /* Increased gap */
        }
        .stats div {
            padding: 12px 20px; /* More padding */
            background-color: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            min-width: 140px; /* Wider stats boxes */
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .stats span {
            font-weight: 700; /* Bolder stats values */
            color: #1e293b;
        }

        /* Button Group */
        .button-group button {
            background-color: #3b82f6;
            color: white;
            padding: 16px 35px; /* Larger buttons */
            border: none;
            border-radius: 12px;
            font-size: 1.3rem; /* Larger font */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 18px rgba(59, 130, 246, 0.35); /* More prominent shadow */
            margin: 8px; /* More margin */
        }
        .button-group button:hover {
            background-color: #2563eb;
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.45);
        }
        .button-group button:active {
            background-color: #1d4ed8;
            transform: translateY(0);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Message Box */
        .message-box {
            background-color: #fff;
            padding: 30px; /* More padding */
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            font-size: 1.3rem;
            color: #1e293b;
            max-width: 450px; /* Slightly wider */
            width: 90%;
            animation: fadeIn 0.3s ease-out;
        }
        .message-box p {
            margin-bottom: 25px;
        }
        .message-box button {
            padding: 12px 25px; /* Larger buttons */
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        .message-box button:hover {
            opacity: 0.9;
        }
        #messageBoxOk {
            background-color: #3b82f6;
        }
        #messageBoxYes {
            background-color: #10b981; /* Green for positive action */
        }
        #messageBoxNo {
            background-color: #ef4444; /* Red for negative action */
        }
        .overlay {
            background: rgba(0, 0, 0, 0.6); /* Darker overlay */
        }

        /* Virtual Keyboard Styles */
        .keyboard-container {
            background-color: #f1f5f9; /* Lighter background for keyboard */
            border-radius: 15px;
            padding: 25px; /* More padding */
            margin-bottom: 30px;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 10px; /* Increased gap between rows */
            border: 1px solid #e2e8f0;
        }
        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 7px; /* Increased gap between keys */
        }
        .keyboard-key {
            background-color: #e2e8f0; /* Slightly darker key background */
            color: #334155;
            padding: 12px 14px; /* More padding */
            border-radius: 10px; /* More rounded keys */
            font-size: 1.1rem; /* Slightly larger key font */
            font-weight: 700; /* Bolder key labels */
            min-width: 50px; /* Slightly wider keys */
            text-align: center;
            cursor: default;
            user-select: none;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); /* Clearer key shadow */
            transition: background-color 0.1s, transform 0.05s, box-shadow 0.1s;
            border: 1px solid #cbd5e1;
        }
        .keyboard-key.wide {
            min-width: 90px;
        }
        .keyboard-key.extra-wide {
            min-width: 110px;
        }
        .keyboard-key.space {
            min-width: 350px;
        }

        /* Key highlight for current character */
        .keyboard-key.highlight-current {
            background-color: #60a5fa; /* Vibrant blue for current key */
            color: white;
            transform: translateY(-2px); /* More lift */
            box-shadow: 0 6px 12px rgba(96, 165, 250, 0.5); /* Stronger glow */
            border-color: #3b82f6;
        }

        /* Key pressed effect */
        .keyboard-key.key-pressed {
            background-color: #3b82f6;
            color: white;
            transform: translateY(0);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            border-color: #2563eb;
        }

        /* Home row keys */
        .keyboard-key[data-key="f"],
        .keyboard-key[data-key="j"] {
            background-color: #facc15; /* Brighter yellow for home row bumps */
            color: #422006; /* Darker text for contrast */
            box-shadow: 0 3px 6px rgba(250, 204, 21, 0.4);
        }

        /* Hand placement guidance */
        .hand-guidance {
            font-size: 1rem; /* Slightly larger font */
            color: #475569;
            margin-top: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: left;
            background-color: #f8fafc;
            padding: 20px; /* More padding */
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .hand-guidance strong {
            color: #1e293b;
        }

        /* Level Selector */
        .level-selector {
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* Increased gap */
        }
        .level-selector label {
            font-size: 1.2rem; /* Larger font */
            font-weight: 700;
            color: #334155;
        }
        .level-selector select {
            padding: 12px 20px; /* Larger padding */
            border: 2px solid #94a3b8;
            border-radius: 10px;
            font-size: 1.2rem;
            background-color: white;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%236B7280' d='M9.293 12.95l.707.707L15 8.172l-1.414-1.414L10 10.343l-3.586-3.585L5 8.172z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center; /* Adjusted position */
            background-size: 1.4em; /* Larger arrow */
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .level-selector select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
        }

        /* Game Canvas Styles */
        #gameCanvas {
            display: none;
            width: 100%;
            height: 180px; /* Taller canvas */
            max-width: 850px; /* Match container width */
            margin: 0 auto 30px auto;
            border: 2px solid #a78bfa; /* Purple border for fun */
            border-radius: 15px;
            background: linear-gradient(to bottom, #a0c4ff, #8cb4ff); /* Gradient sky */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Tutor speaking indicator */
        #tutorSpeaking {
            background-color: #dbeafe; /* Light blue background */
            color: #1e40af; /* Darker blue text */
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            border: 1px solid #bfdbfe;
        }
        #tutorSpeaking .dot {
            width: 8px;
            height: 8px;
            background-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.5s infinite ease-in-out;
        }
        #tutorSpeaking .dot:nth-child(2) { animation-delay: 0.2s; }
        #tutorSpeaking .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }


        /* Keyframe for fadeIn animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }
            .text-display {
                font-size: 1.2rem;
                padding: 20px;
                min-height: 100px;
            }
            .input-field {
                font-size: 1.2rem;
                padding: 15px 20px;
            }
            .stats {
                gap: 10px;
            }
            .stats div {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 1.1rem;
            }
            .button-group button {
                padding: 14px 28px;
                font-size: 1.1rem;
            }
            .keyboard-key {
                min-width: 40px;
                font-size: 0.95rem;
                padding: 10px 10px;
            }
            .keyboard-key.wide {
                min-width: 70px;
            }
            .keyboard-key.extra-wide {
                min-width: 90px;
            }
            .keyboard-key.space {
                min-width: 250px;
            }
            .keyboard-container {
                padding: 20px;
                gap: 8px;
            }
            .keyboard-row {
                gap: 5px;
            }
            .hand-guidance {
                font-size: 0.9rem;
                padding: 15px;
            }
            .level-selector label {
                font-size: 1.1rem;
            }
            .level-selector select {
                font-size: 1.1rem;
                padding: 10px 15px;
            }
            #gameCanvas {
                height: 150px;
            }
            #tutorSpeaking {
                font-size: 1rem;
                padding: 8px 15px;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            h1 {
                font-size: 2.2rem;
                margin-bottom: 20px;
            }
            .text-display {
                font-size: 1rem;
                line-height: 1.5;
                padding: 15px;
                min-height: 80px;
                margin-bottom: 20px;
            }
            .input-field {
                font-size: 1.1rem; /* Adjusted for smaller screens */
                padding: 12px 15px;
                margin-bottom: 20px;
            }
            .stats {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
            }
            .stats div {
                width: 90%;
                min-width: auto;
            }
            .button-group button {
                padding: 10px 20px;
                font-size: 1rem;
                margin: 5px;
            }
            .level-selector {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
            }
            .level-selector select {
                width: 100%;
                max-width: 200px;
                font-size: 1rem;
                padding: 8px 12px;
            }
            .keyboard-key {
                min-width: 28px;
                font-size: 0.75rem;
                padding: 5px 6px;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            }
            .keyboard-key.wide {
                min-width: 45px;
            }
            .keyboard-key.extra-wide {
                min-width: 60px;
            }
            .keyboard-key.space {
                min-width: 120px;
            }
            .keyboard-container {
                padding: 15px;
                gap: 6px;
                margin-bottom: 20px;
            }
            .keyboard-row {
                gap: 3px;
            }
            .hand-guidance {
                font-size: 0.8rem;
                padding: 10px;
                margin-top: 10px;
                margin-bottom: 10px;
            }
            #gameCanvas {
                height: 120px;
                margin-bottom: 20px;
            }
            .message-box {
                padding: 20px;
                font-size: 1rem;
            }
            #tutorSpeaking {
                font-size: 0.9rem;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold mb-6">Fast Typing Keyboard</h1>

        <!-- Level Selector -->
        <div class="level-selector">
            <label for="levelSelect">Choose Level:</label>
            <select id="levelSelect" class="cursor-pointer">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>

        <!-- Hand Placement Guidance -->
        <div class="hand-guidance">
            <p><strong>Hand Placement Guide:</strong></p>
            <ul class="list-disc list-inside mt-2 text-sm">
                <li>Place your left index finger on <strong class="text-yellow-600">F</strong> and right index finger on <strong class="text-yellow-600">J</strong> (these keys often have a small bump).</li>
                <li>Your other fingers should naturally rest on the keys next to them:
                    <ul class="list-disc list-inside ml-4">
                        <li>Left hand: Pinky on A, Ring on S, Middle on D, Index on F.</li>
                        <li>Right hand: Index on J, Middle on K, Ring on L, Pinky on ; (semicolon).</li>
                    </ul>
                </li>
                <li>Thumbs rest lightly on the **Spacebar**.</li>
                <li>Always return your fingers to the home row after striking a key.</li>
            </ul>
        </div>

        <!-- Virtual Keyboard Display -->
        <div class="keyboard-container">
            <div class="keyboard-row">
                <span class="keyboard-key" data-key="`">`</span>
                <span class="keyboard-key" data-key="1">1</span>
                <span class="keyboard-key" data-key="2">2</span>
                <span class="keyboard-key" data-key="3">3</span>
                <span class="keyboard-key" data-key="4">4</span>
                <span class="keyboard-key" data-key="5">5</span>
                <span class="keyboard-key" data-key="6">6</span>
                <span class="keyboard-key" data-key="7">7</span>
                <span class="keyboard-key" data-key="8">8</span>
                <span class="keyboard-key" data-key="9">9</span>
                <span class="keyboard-key" data-key="0">0</span>
                <span class="keyboard-key" data-key="-">-</span>
                <span class="keyboard-key" data-key="=">=</span>
                <span class="keyboard-key wide" data-key="backspace">Backspace</span>
            </div>
            <div class="keyboard-row">
                <span class="keyboard-key wide" data-key="tab">Tab</span>
                <span class="keyboard-key" data-key="q">Q</span>
                <span class="keyboard-key" data-key="w">W</span>
                <span class="keyboard-key" data-key="e">E</span>
                <span class="keyboard-key" data-key="r">R</span>
                <span class="keyboard-key" data-key="t">T</span>
                <span class="keyboard-key" data-key="y">Y</span>
                <span class="keyboard-key" data-key="u">U</span>
                <span class="keyboard-key" data-key="i">I</span>
                <span class="keyboard-key" data-key="o">O</span>
                <span class="keyboard-key" data-key="p">P</span>
                <span class="keyboard-key" data-key="[">[</span>
                <span class="keyboard-key" data-key="]">]</span>
                <span class="keyboard-key wide" data-key="\-backslash">\</span>
            </div>
            <div class="keyboard-row">
                <span class="keyboard-key wide" data-key="capslock">Caps Lock</span>
                <span class="keyboard-key" data-key="a">A</span>
                <span class="keyboard-key" data-key="s">S</span>
                <span class="keyboard-key" data-key="d">D</span>
                <span class="keyboard-key" data-key="f">F</span>
                <span class="keyboard-key" data-key="g">G</span>
                <span class="keyboard-key" data-key="h">H</span>
                <span class="keyboard-key" data-key="j">J</span>
                <span class="keyboard-key" data-key="k">K</span>
                <span class="keyboard-key" data-key="l">L</span>
                <span class="keyboard-key" data-key=";">;</span>
                <span class="keyboard-key" data-key="'">'</span>
                <span class="keyboard-key wide" data-key="enter">Enter</span>
            </div>
            <div class="keyboard-row">
                <span class="keyboard-key extra-wide" data-key="shift-left">Shift</span>
                <span class="keyboard-key" data-key="z">Z</span>
                <span class="keyboard-key" data-key="x">X</span>
                <span class="keyboard-key" data-key="c">C</span>
                <span class="keyboard-key" data-key="v">V</span>
                <span class="keyboard-key" data-key="b">B</span>
                <span class="keyboard-key" data-key="n">N</span>
                <span class="keyboard-key" data-key="m">M</span>
                <span class="keyboard-key" data-key=",">,</span>
                <span class="keyboard-key" data-key=".">.</span>
                <span class="keyboard-key" data-key="/">/</span>
                <span class="keyboard-key extra-wide" data-key="shift-right">Shift</span>
            </div>
            <div class="keyboard-row">
                <span class="keyboard-key wide" data-key="control-left">Ctrl</span>
                <span class="keyboard-key wide" data-key="alt-left">Alt</span>
                <span class="keyboard-key space" data-key=" ">Space</span>
                <span class="keyboard-key wide" data-key="alt-right">Alt</span>
                <span class="keyboard-key wide" data-key="control-right">Ctrl</span>
            </div>
        </div>

        <!-- Game Canvas -->
        <canvas id="gameCanvas"></canvas>

        <!-- Text Display Area -->
        <div id="textDisplay" class="text-display"></div>

        <!-- User Input Field -->
        <input type="text" id="typingInput" class="input-field" placeholder="Start typing here..." autofocus disabled>

        <!-- Stats Section -->
        <div class="stats">
            <div>WPM: <span id="wpm">0</span></div>
            <div>Accuracy: <span id="accuracy">100%</span></div>
            <div>Time: <span id="timer">0s</span></div>
            <div>Errors: <span id="errors">0</span></div> <!-- New: Errors display -->
        </div>

        <!-- Control Buttons -->
        <div class="button-group">
            <button id="startButton">Start Test</button>
        </div>
    </div>

    <!-- Message Box for Alerts -->
    <div id="overlay" class="overlay"></div>
    <div id="messageBox" class="message-box hidden">
        <p id="messageText"></p>
        <div id="messageBoxButtons" class="flex justify-center gap-4 mt-4">
            <button id="messageBoxOk" class="px-5 py-2 rounded-lg text-white">OK</button>
            <button id="messageBoxYes" class="hidden px-5 py-2 rounded-lg text-white">Yes, play game!</button>
            <button id="messageBoxNo" class="hidden px-5 py-2 rounded-lg text-white">No, thanks</button>
        </div>
    </div>

    <!-- Tutor Speaking Indicator -->
    <div id="tutorSpeaking" class="absolute top-4 right-4 flex hidden items-center justify-center">
        <span class="text-sm mr-2">Tutor is speaking...</span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>

    <script>
        // Sentences for different typing levels
        const levelSentences = {
            beginner: [
                "a s d f j k l ;",
                "a a a s s s d d d",
                "f j f j k l k l",
                "the and for is it",
                "a cat a dog a hat",
                "my pen my bag my book",
                "i am you are he is",
                "go go go no no no",
                "yes yes yes one two three",
                "red blue green yellow"
            ],
            intermediate: [
                "The quick brown fox jumps over the lazy dog.",
                "Never underestimate the power of a good book.",
                "Technology has revolutionized the way we live and work.",
                "The sun always shines brightest after the rain.",
                "Learning a new skill can open up many opportunities.",
                "Practice makes perfect, especially in typing.",
                "The early bird catches the worm.",
                "Innovation is the key to progress.",
                "Coding is a blend of logic and creativity.",
                "The mountains are calling and I must go."
            ],
            advanced: [
                "In the realm of artificial intelligence, machine learning algorithms continuously refine their predictive models based on vast datasets, leading to breakthroughs in various scientific disciplines.",
                "The unparalleled beauty of the Aurora Borealis, visible only in the extreme northern and southern latitudes, is a breathtaking celestial phenomenon caused by the collision of solar wind particles with Earth's magnetosphere.",
                "Quantum computing promises to revolutionize cryptography and drug discovery by leveraging the principles of superposition and entanglement, enabling calculations far beyond the capabilities of classical computers.",
                "Sustainable urban development integrates ecological principles with socioeconomic considerations to create resilient, livable cities that minimize environmental impact and promote community well-being.",
                "The intricacies of classical music composition often involve complex counterpoint, harmonic progressions, and thematic development, reflecting centuries of evolving artistic expression and theoretical innovation."
            ]
        };

        // Get DOM elements
        const textDisplay = document.getElementById('textDisplay');
        const typingInput = document.getElementById('typingInput');
        const wpmSpan = document.getElementById('wpm');
        const accuracySpan = document.getElementById('accuracy');
        const timerSpan = document.getElementById('timer');
        const errorsSpan = document.getElementById('errors'); // New: Errors display element
        const startButton = document.getElementById('startButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxOk = document.getElementById('messageBoxOk');
        const messageBoxYes = document.getElementById('messageBoxYes');
        const messageBoxNo = document.getElementById('messageBoxNo');
        const overlay = document.getElementById('overlay');
        const levelSelect = document.getElementById('levelSelect');
        const keyboardKeys = document.querySelectorAll('.keyboard-key');
        const gameCanvas = document.getElementById('gameCanvas');
        const tutorSpeakingIndicator = document.getElementById('tutorSpeaking');

        // Game state variables
        let currentText = '';
        let currentIndex = 0;
        let startTime = 0;
        let timerInterval = null;
        let totalTypedCharacters = 0;
        let correctCharacters = 0;
        let errors = 0;
        let testStarted = false;
        let currentLevel = 'beginner'; // Default level
        let previousTypedValueLength = 0; // To track new characters for game speed
        let testsCompletedCount = 0; // Counter for completed tests
        let gameEnabled = false; // Flag to enable/disable the car game
        const GAME_PROMPT_THRESHOLD = 3; // Number of tests before prompting for the game
        let firstTestEverStarted = false; // New flag to track the very first test start for welcome message

        // Game canvas variables
        const ctx = gameCanvas.getContext('2d');
        let carX = gameCanvas.width / 4; // Car's X position on canvas
        const carY = gameCanvas.height - 40; // Car's Y position (constant, near bottom of canvas)
        let gameSpeed = 0; // Initial speed of the game visual (road movement)
        const maxGameSpeed = 10; // Max speed for the car visual
        const speedIncrement = 0.5; // How much speed increases per correct char
        const speedDecrement = 1; // How much speed decreases per incorrect char
        let roadLineOffset = 0; // For animating road lines
        let animationFrameId = null; // For requestAnimationFrame

        /**
         * Adjusts the canvas dimensions to be responsive.
         */
        function setupCanvas() {
            gameCanvas.width = gameCanvas.offsetWidth;
            gameCanvas.height = gameCanvas.offsetHeight;
            // Re-calculate carX based on new width
            carX = gameCanvas.width / 4;
        }

        /**
         * Shows a custom message box instead of alert().
         * @param {string} message The message to display.
         * @param {boolean} [isGamePrompt=false] True if this is a game prompt, showing Yes/No buttons.
         */
        function showMessageBox(message, isGamePrompt = false) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            overlay.style.display = 'block';
            typingInput.disabled = true;
            startButton.disabled = true; // Disable main start button while message box is open

            if (isGamePrompt) {
                messageBoxOk.classList.add('hidden');
                messageBoxYes.classList.remove('hidden');
                messageBoxNo.classList.remove('hidden');
            } else {
                messageBoxOk.classList.remove('hidden');
                messageBoxYes.classList.add('hidden');
                messageBoxNo.classList.add('hidden');
            }
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            overlay.style.display = 'none';
            startButton.disabled = false; // Re-enable main start button
            if (testStarted) { // Only re-enable typing input if a test is ongoing (e.g., after dismissing a non-game message)
                typingInput.disabled = false;
                typingInput.focus();
            } else {
                // If test is not started (e.g., after test finished message), ensure input remains disabled until start is clicked
                typingInput.disabled = true;
            }
        }

        // Event listeners for message box buttons
        messageBoxOk.addEventListener('click', () => {
            hideMessageBox();
            if (!testStarted) { // If test just finished and OK was clicked, prepare for a new test
                startButton.textContent = 'Start New Test';
            }
        });

        messageBoxYes.addEventListener('click', () => {
            gameEnabled = true;
            testsCompletedCount = 0; // Reset counter so the game is now permanently active (until reload)
            hideMessageBox();
            startActualTest(); // Immediately start a new test with game enabled
        });

        messageBoxNo.addEventListener('click', () => {
            gameEnabled = false;
            testsCompletedCount = 0; // Reset counter so prompt reappears after next GAME_PROMPT_THRESHOLD tests
            hideMessageBox();
            startActualTest(); // Immediately start a new test without game enabled
        });

        /**
         * Selects a random sentence based on the current level.
         * @returns {string} A random sentence from the selected level's list.
         */
        function getRandomSentenceForLevel() {
            const sentences = levelSentences[currentLevel];
            const randomIndex = Math.floor(Math.random() * sentences.length);
            return sentences[randomIndex];
        }

        /**
         * Clears all key highlights on the virtual keyboard.
         */
        function clearKeyHighlights() {
            keyboardKeys.forEach(key => {
                key.classList.remove('highlight-current', 'key-pressed');
            });
        }

        /**
         * Highlights the current character's key on the virtual keyboard.
         */
        function highlightCurrentKey() {
            clearKeyHighlights();
            if (currentIndex < currentText.length) {
                let charToHighlight = currentText[currentIndex];
                let keyElement = null;

                // Handle Shift for uppercase letters and symbols
                if (charToHighlight === charToHighlight.toUpperCase() && charToHighlight.match(/[A-Z]/)) {
                    keyElement = document.querySelector(`.keyboard-key[data-key="${charToHighlight.toLowerCase()}"]`);
                    document.querySelector('.keyboard-key[data-key="shift-left"]').classList.add('highlight-current');
                    document.querySelector('.keyboard-key[data-key="shift-right"]').classList.add('highlight-current');
                } else if (charToHighlight.match(/[!@#$%^&*()_+{}:"<>?~|]/)) {
                    const specialKeys = {
                        '!': '1', '@': '2', '#': '3', '$': '4', '%': '5', '^': '6', '&': '7', '*': '8', '(': '9', ')': '0',
                        '_': '-', '+': '=', '{': '[', '}': ']', ':': ';', '"': "'", '<': ',', '>': '.', '?': '/', '|': '\\-backslash'
                    };
                    const baseKey = specialKeys[charToHighlight];
                    if (baseKey) {
                        keyElement = document.querySelector(`.keyboard-key[data-key="${baseKey}"]`);
                        document.querySelector('.keyboard-key[data-key="shift-left"]').classList.add('highlight-current');
                        document.querySelector('.keyboard-key[data-key="shift-right"]').classList.add('highlight-current');
                    }
                } else if (charToHighlight === ' ') {
                     keyElement = document.querySelector(`.keyboard-key[data-key=" "]`);
                }
                else {
                    keyElement = document.querySelector(`.keyboard-key[data-key="${charToHighlight.toLowerCase()}"]`);
                }

                if (keyElement) {
                    keyElement.classList.add('highlight-current');
                }
            }
        }

        /**
         * Simulates a key press on the virtual keyboard.
         * @param {string} key The character or data-key value of the pressed key.
         */
        function simulateKeyPress(key) {
            let keyToPress = key.toLowerCase();
            if (key === ' ') {
                keyToPress = ' ';
            } else if (key === '\\') {
                keyToPress = '\\-backslash';
            }

            const keyElement = document.querySelector(`.keyboard-key[data-key="${keyToPress}"]`);
            if (keyElement) {
                keyElement.classList.add('key-pressed');
                setTimeout(() => {
                    keyElement.classList.remove('key-pressed');
                }, 150);
            }

            document.querySelector('.keyboard-key[data-key="shift-left"]').classList.remove('key-pressed');
            document.querySelector('.keyboard-key[data-key="shift-right"]').classList.remove('key-pressed');
        }

        /**
         * Renders the text in the display area, highlighting correct, incorrect, and current characters.
         */
        function renderText() {
            textDisplay.innerHTML = '';
            currentText.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char;
                if (index < currentIndex) {
                    if (typingInput.value[index] === char) {
                        span.classList.add('correct');
                    } else {
                        span.classList.add('incorrect');
                    }
                } else if (index === currentIndex) {
                    span.classList.add('current');
                }
                textDisplay.appendChild(span);
            });
            const currentSpan = textDisplay.querySelector('.current');
            if (currentSpan) {
                const textDisplayRect = textDisplay.getBoundingClientRect();
                const currentSpanRect = currentSpan.getBoundingClientRect();

                if (currentSpanRect.top < textDisplayRect.top || currentSpanRect.bottom > textDisplayRect.bottom) {
                    textDisplay.scrollTop += currentSpanRect.top - textDisplayRect.top - (textDisplay.clientHeight / 3);
                }
            }
            highlightCurrentKey();
        }

        /**
         * Calculates and updates WPM and accuracy, including errors.
         */
        function updateStats() {
            const elapsedTime = (Date.now() - startTime) / 1000;
            timerSpan.textContent = `${Math.floor(elapsedTime)}s`;

            if (elapsedTime > 0) {
                const wordsTyped = correctCharacters / 5;
                const wpm = Math.round((wordsTyped / elapsedTime) * 60);
                wpmSpan.textContent = wpm;

                const accuracy = totalTypedCharacters === 0 ? 100 : Math.round((correctCharacters / totalTypedCharacters) * 100);
                accuracySpan.textContent = `${accuracy}%`;
                errorsSpan.textContent = errors; // Update errors display
            } else {
                wpmSpan.textContent = '0';
                accuracySpan.textContent = '100%';
                errorsSpan.textContent = '0'; // Ensure errors is 0 initially
            }
        }

        /**
         * Resets the game to its initial state, preparing for a new test.
         */
        function resetGame() {
            clearInterval(timerInterval);
            currentText = getRandomSentenceForLevel();
            currentIndex = 0;
            startTime = 0;
            totalTypedCharacters = 0;
            correctCharacters = 0;
            errors = 0; // Reset errors on game reset
            testStarted = false;
            previousTypedValueLength = 0;

            typingInput.value = '';
            typingInput.disabled = true;
            wpmSpan.textContent = '0';
            accuracySpan.textContent = '100%';
            timerSpan.textContent = '0s';
            errorsSpan.textContent = '0'; // Reset errors display
            startButton.textContent = 'Start Test';
            startButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            startButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            levelSelect.disabled = false;

            gameSpeed = 0; // Stop car animation on reset
            gameCanvas.style.display = 'none'; // Ensure canvas is hidden on reset

            renderText();
        }

        /**
         * Starts the actual typing test, managing game visibility.
         */
        function startActualTest() {
            // If it's the very first time starting the test, play the welcome message.
            if (!firstTestEverStarted) {
                speakWelcomeMessage();
                firstTestEverStarted = true; // Set the flag to true after the first play
            }

            resetGame(); // Ensure everything is clean for the new test
            testStarted = true;
            typingInput.disabled = false;
            typingInput.focus();
            startTime = Date.now();
            timerInterval = setInterval(updateStats, 1000);
            startButton.textContent = 'Reset Test';
            startButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            startButton.classList.add('bg-green-600', 'hover:bg-green-700');
            levelSelect.disabled = true;

            if (gameEnabled) { // Show canvas if game is enabled
                gameCanvas.style.display = 'block';
            } else {
                gameCanvas.style.display = 'none'; // Keep canvas hidden if game is not enabled
            }
        }


        /**
         * Handles user input from the typing field, updating typing stats and game speed.
         * @param {Event} event The input event.
         */
        function handleInput(event) {
            if (!testStarted) return;

            const typedValue = typingInput.value;

            // Simulate key press on virtual keyboard
            if (event.data) {
                simulateKeyPress(event.data);
            }

            // Logic for updating correct/incorrect characters and index, and influencing game speed
            if (typedValue.length > previousTypedValueLength) {
                // A new character was added
                const originalChar = currentText[typedValue.length - 1];
                const typedChar = typedValue[typedValue.length - 1];
                if (typedChar === originalChar) {
                    // Correct new character
                    if (gameEnabled) updateGameSpeed(true);
                } else {
                    // Incorrect new character
                    if (gameEnabled) updateGameSpeed(false);
                }
            } // No speed change for backspace or in-place replacement.

            // Recalculate correctCharacters and errors based on the *entire* current typedValue
            correctCharacters = 0;
            errors = 0;
            for (let i = 0; i < typedValue.length; i++) {
                if (typedValue[i] === currentText[i]) {
                    correctCharacters++;
                } else {
                    errors++;
                }
            }

            currentIndex = typedValue.length;
            totalTypedCharacters = typedValue.length;
            previousTypedValueLength = typedValue.length;

            renderText();
            updateStats();

            // Check if the user has finished typing the entire text
            if (currentIndex === currentText.length && typedValue.length === currentText.length) {
                clearInterval(timerInterval);
                testStarted = false;
                typingInput.disabled = true;

                const finalWPM = wpmSpan.textContent;
                const finalAccuracy = accuracySpan.textContent;
                const finalErrors = errorsSpan.textContent; // Get final errors

                testsCompletedCount++; // Increment count only on successful completion

                clearKeyHighlights();
                gameSpeed = 0; // Stop car when test ends

                // Check if it's time to prompt for the game
                if (!gameEnabled && testsCompletedCount >= GAME_PROMPT_THRESHOLD) {
                    showMessageBox(
                        `Test Finished! Your WPM: ${finalWPM}, Accuracy: ${finalAccuracy}, Errors: ${finalErrors}. You've completed ${testsCompletedCount} practice rounds. Would you like to enable the typing car game for more fun?`,
                        true
                    );
                } else {
                    // Regular completion message
                    showMessageBox(`Test Finished! Your WPM: ${finalWPM}, Accuracy: ${finalAccuracy}, Errors: ${finalErrors}.`);
                    startButton.textContent = 'Start New Test';
                }
            }
        }

        // --- Game Canvas Drawing Functions ---

        /**
         * Draws the car on the canvas.
         */
        function drawCar() {
            // Body
            ctx.fillStyle = '#3b82f6'; /* Blue car */
            ctx.beginPath();
            ctx.roundRect(carX, carY - 20, 60, 20, 5); /* Main body */
            ctx.fill();

            // Cabin
            ctx.fillStyle = '#60a5fa'; /* Lighter blue for cabin */
            ctx.beginPath();
            ctx.roundRect(carX + 10, carY - 35, 40, 15, 3);
            ctx.fill();

            // Wheels
            ctx.fillStyle = '#334155'; /* Dark grey for wheels */
            ctx.beginPath();
            ctx.arc(carX + 15, carY + 5, 10, 0, Math.PI * 2);
            ctx.arc(carX + 45, carY + 5, 10, 0, Math.PI * 2);
            ctx.fill();
        }

        /**
         * Draws the road on the canvas, with animated lines.
         */
        function drawRoad() {
            ctx.fillStyle = '#6b7280'; /* Darker grey for road */
            ctx.fillRect(0, gameCanvas.height - 20, gameCanvas.width, 20); /* Road base */

            // Road lines
            ctx.fillStyle = '#fcd34d'; /* Yellow lines */
            const lineHeight = 5;
            const lineGap = 15;
            const lineWidth = 30;
            const totalLinePattern = lineWidth + lineGap; /* Space occupied by one line + gap */

            roadLineOffset += gameSpeed * 0.5; /* Move lines based on game speed (adjusted for visual smoothness) */
            if (roadLineOffset > totalLinePattern) {
                roadLineOffset %= totalLinePattern;
            }

            // Draw multiple lines to cover the entire width
            for (let i = -2; i < gameCanvas.width / totalLinePattern + 2; i++) { /* Render extra lines off-screen for seamless loop */
                ctx.fillRect(i * totalLinePattern + roadLineOffset, gameCanvas.height - 10, lineWidth, 2); /* Dashed lines */
            }
        }

        /**
         * Updates the game speed based on typing correctness.
         * @param {boolean} isCorrect True if the last typed character was correct, false otherwise.
         */
        function updateGameSpeed(isCorrect) {
            if (isCorrect) {
                gameSpeed = Math.min(maxGameSpeed, gameSpeed + speedIncrement);
            } else {
                gameSpeed = Math.max(0, gameSpeed - speedDecrement);
            }
        }

        /**
         * Main game animation loop. Clears canvas, draws elements, and requests next frame.
         */
        function gameLoop() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height); /* Clear canvas */

            if (gameEnabled) { /* Only draw game elements if game is enabled */
                drawRoad();
                drawCar();
            } else {
                // Draw a static background if game is not enabled to avoid blank canvas
                ctx.fillStyle = '#a0c4ff'; /* Sky color */
                ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Utility functions for audio conversion (PCM to WAV)
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            // RIFF identifier
            writeString(view, 0, 'RIFF');
            // File length (placeholder)
            view.setUint32(4, 36 + pcm16.length * 2, true); // 36 + dataSize
            // RIFF type
            writeString(view, 8, 'WAVE');
            // format chunk identifier
            writeString(view, 12, 'fmt ');
            // format chunk length
            view.setUint32(16, 16, true);
            // sample format (raw PCM)
            view.setUint16(20, 1, true);
            // channel count
            view.setUint16(22, 1, true); // Mono
            // sample rate
            view.setUint32(24, sampleRate, true);
            // byte rate (sample rate * block align)
            view.setUint32(28, sampleRate * 2, true); // 2 bytes per sample
            // block align (channel count * bytes per sample)
            view.setUint16(32, 2, true); // 1 channel * 2 bytes/sample
            // bits per sample
            view.setUint16(34, 16, true); // PCM 16-bit
            // data chunk identifier
            writeString(view, 36, 'data');
            // data chunk length (placeholder)
            view.setUint32(40, pcm16.length * 2, true); // dataSize

            const blob = new Blob([wavHeader, pcm16], { type: 'audio/wav' });
            return blob;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function speakWelcomeMessage() {
            const welcomeMessage = "Welcome to your online fast typing class! Let's get started.";

            tutorSpeakingIndicator.style.display = 'flex'; // Show indicator

            const payload = {
                contents: [{
                    parts: [{ text: welcomeMessage }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // A female-sounding voice
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = ""; // Leave as-is, Canvas will provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; // Default if not found

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audio = new Audio(URL.createObjectURL(wavBlob)); // Create URL from blob
                    audio.play();

                    audio.onended = () => {
                        tutorSpeakingIndicator.style.display = 'none'; // Hide indicator when done
                    };
                } else {
                    console.error('Error: Audio data or mime type missing from API response.', result);
                    tutorSpeakingIndicator.textContent = "Tutor could not speak.";
                    setTimeout(() => tutorSpeakingIndicator.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error calling TTS API:', error);
                tutorSpeakingIndicator.textContent = "Error speaking.";
                setTimeout(() => tutorSpeakingIndicator.style.display = 'none', 3000);
            }
        }


        // Event listener for the main Start/Reset button
        startButton.addEventListener('click', () => {
            if (testStarted) { /* If a test is currently running, this button acts as "Reset" */
                resetGame();
            } else { /* If no test is running, this button acts as "Start" */
                if (!gameEnabled && testsCompletedCount >= GAME_PROMPT_THRESHOLD) {
                    showMessageBox(
                        `You've completed ${testsCompletedCount} practice rounds! Would you like to enable the typing car game for more fun?`,
                        true
                    );
                } else {
                    // Either game is already enabled, or not enough tests completed for prompt
                    startActualTest();
                }
            }
        });

        typingInput.addEventListener('input', handleInput);

        levelSelect.addEventListener('change', (event) => {
            currentLevel = event.target.value;
            resetGame(); /* Reset game with new level's sentences */
        });

        // Initialize the game and start the animation loop when the page loads
        window.onload = function() {
            setupCanvas(); /* Set up canvas dimensions */
            resetGame(); /* Set up initial text and disable input, reset typing stats */
            gameLoop(); /* Start the animation loop (car will be static until test starts) */
            // speakWelcomeMessage() is now called when the test actually starts via startActualTest()
        };

        // Handle canvas resize
        window.addEventListener('resize', setupCanvas);
    </script>
</body>
</html>
